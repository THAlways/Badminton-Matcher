<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Badminton Matcher v2.5</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <!-- html2canvas for exporting images -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #0f766e;
      --primary-hover: #115e59;
      --primary-light: #ccfbf1;
      --secondary: #f8fafc;
      --accent: #f59e0b;
      --danger: #ef4444;
      --consecutive: #2563eb;
      --text-main: #334155;
      --text-muted: #64748b;
      --bg-card: #ffffff;
    }

    body {
      margin: 0;
      font-family: "Kanit", sans-serif;
      background: var(--secondary);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 6rem;
      font-size: 16px;
    }

    header {
      background: #fff;
      padding: 0.8rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
    }

    main {
      max-width: 640px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Tabs */
    .tabs {
      position: sticky;
      top: 3.5rem;
      z-index: 90;
      background: var(--secondary);
      display: flex;
      border-bottom: 1px solid #e2e8f0;
    }

    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 0.8rem 0;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: var(--secondary);
      color: var(--text-main);
    }

    .tab-btn.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary-hover);
    }

    .tab {
      display: none;
      padding: 1rem 0;
    }

    .tab.active {
      display: block;
    }

    /* Card */
    section.card {
      background: var(--bg-card);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Player List */
    .player-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background: #fff;
      height: 36px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .player-item.selected {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary-hover);
      font-weight: 600;
    }

    .player-item .actions {
      display: flex;
      gap: 0.4rem;
    }

    .player-item .actions button {
      width: 36px;
      height: 36px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 0.4rem;
      font-size: 1.1rem;
    }

    /* Input group */
    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .input-group input {
      flex: 1;
      height: 36px;
      line-height: 36px;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      padding: 0 0.75rem;
      font-size: 1rem;
    }

    .input-group button {
      height: 36px;
      border: none;
      background: var(--text-main);
      color: #fff;
      padding: 0 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
    }

    /* Stepper & Control rows */
    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--secondary);
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
      margin-bottom: 0.8rem;
      height: 36px;
    }

    .control-row label {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-main);
    }

    .stepper {
      display: flex;
      align-items: center;
      border: 1px solid #e2e8f0;
      border-radius: 0.4rem;
      background: #fff;
      height: 36px;
    }

    .stepper button {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--text-main);
    }

    .stepper .val {
      min-width: 44px;
      text-align: center;
      font-weight: 600;
      font-size: 1rem;
      border-left: 1px solid #f1f5f9;
      border-right: 1px solid #f1f5f9;
      line-height: 36px;
    }

    .btn-xs {
      font-size: 0.8rem;
      padding: 0.2rem 0.75rem;
      border-radius: 99px;
      border: 1px solid #cbd5e1;
      background: #fff;
      color: var(--primary);
      height: 36px;
      line-height: 34px;
      cursor: pointer;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 500px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .notice {
      color: var(--danger);
      font-size: 0.85rem;
      margin-top: 0.4rem;
      display: none;
    }

    /* Action bar */
    .action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 1rem;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      gap: 1rem;
      justify-content: center;
      z-index: 50;
    }

    .action-bar button {
      flex: 1;
      max-width: 200px;
      height: 40px;
      border-radius: 0.6rem;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      line-height: 40px;
    }

    .btn-main {
      background: var(--primary);
      color: #fff;
    }

    .btn-sub {
      background: #fff;
      color: var(--text-main);
      border: 2px solid #e2e8f0;
    }

    .btn-main:disabled,
    .btn-sub:disabled {
      opacity: 0.5;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    th {
      background: #f8fafc;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.85rem;
      padding: 0.65rem;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 0.65rem;
      border-bottom: 1px solid #f1f5f9;
      text-align: center;
      vertical-align: middle;
    }

    .highlight-consecutive {
      color: var(--consecutive) !important;
      font-weight: 700;
    }

    .stat-row {
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .stat-label {
      font-weight: 600;
      color: var(--primary);
      font-size: 1rem;
    }

    .stat-dets {
      display: block;
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .cost-card {
      background: #fff;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }
  </style>
</head>

<body>
  <header>
    <h1>üè∏ Badminton Matcher v2.5</h1>
    <span id="today-date"></span>
  </header>
  <main>
    <div class="tabs">
      <button class="tab-btn active" data-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      <button class="tab-btn" data-tab="schedule">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</button>
      <button class="tab-btn" data-tab="summary">‡∏™‡∏£‡∏∏‡∏õ</button>
    </div>
    <!-- Settings Tab -->
    <div id="settings" class="tab active">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
          <h2 style="margin:0;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô <span id="selected-count"
              style="font-size:0.9em;color:var(--text-muted);font-weight:400;">0/0</span></h2>
          <div style="display:flex;gap:0.5rem;">
            <button id="toggle-list-view" class="btn-xs" style="width:auto;padding:0 0.5rem;">‚ñº ‡∏ã‡πà‡∏≠‡∏ô</button>
            <button id="toggle-filter-sel" class="btn-xs" style="width:auto;padding:0 0.5rem;">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
          </div>
        </div>
        <div class="input-group">
          <input type="text" id="player-name" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." />
          <button id="add-player">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
        <div style="margin-bottom: 0.5rem; margin-top: 0.3rem;">
          <button id="select-all" class="btn-xs">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button id="deselect-all" class="btn-xs">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
        <div id="player-list" class="player-list"></div>
        <div id="need-msg" class="notice"></div>
      </section>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
          <button id="toggle-settings" class="btn-xs" style="width:auto;padding:0 0.5rem;" onclick="toggleSettings()">‚ñº
            ‡∏ã‡πà‡∏≠‡∏ô</button>
        </div>
        <div id="settings-content">
          <div class="settings-grid">
            <div>
              <div class="control-row">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</label>
                <div class="stepper">
                  <button id="court-down">-</button>
                  <div id="court-val" class="val">1</div>
                  <button id="court-up">+</button>
                </div>
              </div>
              <div id="durations-container"></div>
              <div id="warn-msg" class="notice"></div>
            </div>
            <div>
              <div class="control-row">
                <label>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏ó/‡∏ä‡∏°.</label>
                <input type="number" id="court-price" value="249"
                  style="width: 80px; text-align: center; border: 1px solid #cbd5e1; border-radius: 0.3rem; height: 36px; line-height: 36px;" />
              </div>
              <div style="background: #f1f5f9; padding: 0.5rem; border-radius: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <label style="color: var(--text-muted); font-size: 0.85rem; font-weight: 600;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î</label>
                  <button id="add-shuttle" class="btn-xs">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
                <div id="shuttle-list"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h2>
          <button id="toggle-priority" class="btn-xs" style="width:auto;padding:0 0.5rem;" onclick="togglePriority()">‚ñº
            ‡∏ã‡πà‡∏≠‡∏ô</button>
        </div>
        <div id="priority-content">
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: -0.5rem;">
            ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° (0-10):
          </p>
          <div class="control-row">
            <label>‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô</label>
            <div class="stepper">
              <button onclick="changePriority('avoidPlay', -1)">-</button>
              <div class="val" id="prio-avoidPlay"></div>
              <button onclick="changePriority('avoidPlay', +1)">+</button>
            </div>
          </div>
          <div class="control-row">
            <label>‡πÑ‡∏°‡πà‡∏û‡∏±‡∏Å‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô</label>
            <div class="stepper">
              <button onclick="changePriority('avoidRest', -1)">-</button>
              <div class="val" id="prio-avoidRest"></div>
              <button onclick="changePriority('avoidRest', +1)">+</button>
            </div>
          </div>
          <div class="control-row">
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏£‡∏≠‡∏ö</label>
            <div class="stepper">
              <button onclick="changePriority('equalRounds', -1)">-</button>
              <div class="val" id="prio-equalRounds"></div>
              <button onclick="changePriority('equalRounds', +1)">+</button>
            </div>
          </div>
          <div class="control-row">
            <label>‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏π‡πà</label>
            <div class="stepper">
              <button onclick="changePriority('diversePair', -1)">-</button>
              <div class="val" id="prio-diversePair"></div>
              <button onclick="changePriority('diversePair', +1)">+</button>
            </div>
          </div>
      </section>
    </div>
    <!-- Schedule Tab -->
    <div id="schedule" class="tab">
      <section class="card" id="schedule-area" style="min-height:200px;">
        <div id="no-schedule" style="text-align:center;color:var(--text-muted);padding:2rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</div>
        <div id="schedule-table"></div>
        <div id="schedule-export"
          style="display:none;margin-top:1rem;text-align:center;gap:1rem;display:flex;justify-content:center;">
          <button onclick="exportImage('copy','schedule-area')" class="btn-xs"
            style="flex:1;max-width:140px;height:40px;font-size:1rem;">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ ‚øª</button>
          <button onclick="exportImage('share','schedule-area')" class="btn-xs"
            style="flex:1;max-width:140px;height:40px;font-size:1rem;">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ ·Øì‚û§</button>
        </div>
      </section>
    </div>
    <!-- Summary Tab -->
    <div id="summary" class="tab">
      <section class="card" id="summary-area">
        <div id="summary-content"></div>
        <div id="summary-export"
          style="display:none;margin-top:1rem;text-align:center;gap:1rem;display:flex;justify-content:center;">
          <button onclick="exportImage('copy','summary-area')" class="btn-xs"
            style="flex:1;max-width:140px;height:40px;font-size:1rem;">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ ‚øª</button>
          <button onclick="exportImage('share','summary-area')" class="btn-xs"
            style="flex:1;max-width:140px;height:40px;font-size:1rem;">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ ·Øì‚û§</button>
        </div>
      </section>
    </div>
  </main>
  <div class="action-bar">
    <button id="generate" class="btn-main" disabled>‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</button>
    <button id="reset" class="btn-sub" disabled>‡∏•‡πâ‡∏≤‡∏á</button>
    <button id="to-summary" class="btn-sub" style="display:none;">‡πÑ‡∏õ‡∏™‡∏£‡∏∏‡∏õ</button>
  </div>
  <script>
    (function () {
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);
      function varColor(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      }
      function uid() {
        return Math.random().toString(36).substr(2, 9);
      }

      let state = {
        players: [
          { id: '1', name: '‡∏ô‡∏∏‡πâ‡∏¢' },
          { id: '2', name: '‡∏ï‡∏±‡πâ‡∏ô' },
          { id: '3', name: '‡πÅ‡∏à‡πä‡∏Ñ' },
          { id: '4', name: '‡∏û‡∏µ' },
          { id: '5', name: '‡πÑ‡∏Å‡πà' },
          { id: '6', name: '‡∏õ‡∏µ‡πÇ‡∏õ‡πâ' },
          { id: '7', name: '‡∏≠‡∏µ‡∏ü' },
          { id: '8', name: '‡∏ò‡∏ô' },
          { id: '9', name: '‡∏Å‡∏¥‡∏ï' },
          { id: '10', name: '‡πÅ‡∏û‡∏£‡∏ß' },
          { id: '11', name: '‡∏ä‡πâ‡∏≤‡∏á' }
        ],
        selected: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
        listExpanded: true,
        showSelectedOnly: false,
        courts: 1,
        durations: [2],
        courtPrice: 249,
        shuttles: [{ id: uid(), price: 75, qty: 1 }],
        schedule: [],
        scheduleState: null,
        priorities: {
          avoidPlay: 5,
          avoidRest: 5,
          equalRounds: 5,
          diversePair: 5,
          priorityExpanded: true,
          settingsExpanded: true,
        },
      };

      // Load saved players & selections from localStorage
      function loadSaved() {
        try {
          const s = localStorage.getItem('bm_state_v2');
          if (s) {
            const d = JSON.parse(s);
            state.players = d.players || [];
            state.selected = d.selected || [];
            if (d.priorities) state.priorities = d.priorities;
            if (typeof d.listExpanded === 'boolean') state.listExpanded = d.listExpanded;
            if (typeof d.showSelectedOnly === 'boolean') state.showSelectedOnly = d.showSelectedOnly;
            if (typeof d.priorityExpanded === 'boolean') state.priorityExpanded = d.priorityExpanded;
            if (typeof d.settingsExpanded === 'boolean') state.settingsExpanded = d.settingsExpanded;
          }
        } catch (e) { }
      }
      // Save players & selections to localStorage
      function saveSaved() {
        localStorage.setItem('bm_state_v2', JSON.stringify({
          players: state.players,
          selected: state.selected,
          priorities: state.priorities,
          listExpanded: state.listExpanded,
          showSelectedOnly: state.showSelectedOnly,
          priorityExpanded: state.priorityExpanded,
          settingsExpanded: state.settingsExpanded
        }));
      }

      // Initialize date
      document.getElementById("today-date").textContent = new Date().toLocaleDateString("th-TH", {
        weekday: "short",
        day: "numeric",
        month: "short",
        year: "numeric"
      });

      // Tabs
      function activateTab(id) {
        $$(".tab-btn").forEach((b) => b.classList.toggle("active", b.dataset.tab === id));
        $$(".tab").forEach((tab) => tab.classList.toggle("active", tab.id === id));
        if (id === 'summary') drawSummary();
      }
      $$(".tab-btn").forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tab));
      });

      // Render players and save
      function renderPlayers() {
        const list = $("#player-list");
        list.innerHTML = '';
        const required = state.courts * 4;
        $("#selected-count").textContent = `${state.selected.length}/${state.players.length}`;
        $("#generate").disabled = state.selected.length < required;
        $("#reset").disabled = state.schedule.length === 0;
        // UI Controls update
        const btnToggle = $("#toggle-list-view");
        const btnFilter = $("#toggle-filter-sel");
        if (btnToggle) btnToggle.textContent = state.listExpanded ? "‚ñº ‡∏ã‡πà‡∏≠‡∏ô" : "‚ñ∂ ‡πÅ‡∏™‡∏î‡∏á";
        if (btnFilter) {
          btnFilter.style.background = state.showSelectedOnly ? "var(--primary)" : "#fff";
          btnFilter.style.color = state.showSelectedOnly ? "#fff" : "var(--primary)";
        }

        if (!state.listExpanded) {
          list.style.display = 'none';
          // Even if hidden, we need to save state, but renderPlayers handles saving at the end.
          // But we must NOT return before saving if we want consistent saves.
          // However, the original code saves at the end.
          // Let's just hide the list and skip the loop if hidden? 
          // Better to just toggle display.
        } else {
          list.style.display = 'flex';
        }

        state.players.forEach(p => {
          const selected = state.selected.includes(p.id);
          // Filter if needed
          if (state.showSelectedOnly && !selected) return;
          // Hide if list collapsed? accepted above style.display='none' handles it for the container.
          // But if we want to save DOM nodes, we can just skip appending if collapsed. 
          // Let's strictly follow the plan: "Check state.playerListExpanded: hide list if false."
          if (!state.listExpanded) return;

          const div = document.createElement('div');
          div.className = 'player-item' + (selected ? ' selected' : '');
          div.innerHTML = `
            <span style="flex:1;">${p.name}</span>
            <div class="actions">
              <button onclick="editPlayer('${p.id}'); event.stopPropagation();">‚úé</button>
              <button onclick="deletePlayer('${p.id}'); event.stopPropagation();">‚úñ</button>
            </div>`;
          div.onclick = () => toggleSelect(p.id);
          list.appendChild(div);
        });
        if (state.selected.length > 0 && state.selected.length < required) {
          $("#need-msg").style.display = 'block';
          $("#need-msg").textContent = `* ‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${required - state.selected.length} ‡∏Ñ‡∏ô`;
        } else $("#need-msg").style.display = 'none';
        if (state.courts > 1 && state.selected.length < required) {
          $("#warn-msg").style.display = 'block';
          $("#warn-msg").textContent = `* ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${required} ‡∏Ñ‡∏ô`;
        } else $("#warn-msg").style.display = 'none';
        // Save players & selected
        saveSaved();
      }

      // Render settings
      function renderSettings() {
        // Toggle logic for Settings
        const btn = document.getElementById('toggle-settings');
        const cont = document.getElementById('settings-content');
        if (state.settingsExpanded) {
          cont.style.display = 'block';
          if (btn) btn.textContent = '‚ñº ‡∏ã‡πà‡∏≠‡∏ô';
        } else {
          cont.style.display = 'none';
          if (btn) btn.textContent = '‚ñ∂ ‡πÅ‡∏™‡∏î‡∏á';
        }

        $("#court-val").textContent = state.courts;
        $("#court-price").value = state.courtPrice;
        // durations
        const durCont = $("#durations-container");
        durCont.innerHTML = '';
        state.durations.forEach((d, i) => {
          const row = document.createElement('div');
          row.className = 'control-row';
          row.innerHTML = `
            <label>‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${i + 1} (‡∏ä‡∏°.)</label>
            <div class="stepper">
              <button onclick="changeDur(${i}, -1)">-</button>
              <div class="val">${d}</div>
              <button onclick="changeDur(${i}, 1)">+</button>
            </div>`;
          durCont.appendChild(row);
        });
        renderShuttles();
        renderPriorities();
      }

      function renderShuttles() {
        const cont = $("#shuttle-list");
        cont.innerHTML = '';
        state.shuttles.forEach((s, idx) => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '0.4rem';
          row.style.marginBottom = '0.4rem';
          const inp = document.createElement('input');
          inp.type = 'number';
          inp.value = s.price;
          inp.style.width = '80px';
          inp.style.textAlign = 'center';
          inp.style.height = '36px';
          inp.style.lineHeight = '36px';
          inp.style.border = '1px solid #cbd5e1';
          inp.style.borderRadius = '0.3rem';
          inp.oninput = (e) => s.price = parseInt(e.target.value) || 0;
          const step = document.createElement('div');
          step.className = 'stepper';
          step.innerHTML = `<button>-</button><div class="val">${s.qty}</div><button>+</button>`;
          step.firstChild.onclick = () => { if (s.qty > 0) s.qty--; step.querySelector('.val').textContent = s.qty; };
          step.lastChild.onclick = () => { s.qty++; step.querySelector('.val').textContent = s.qty; };
          row.appendChild(inp);
          row.appendChild(step);
          if (state.shuttles.length > 1) {
            const del = document.createElement('button');
            del.textContent = '‚úñ';
            del.style.border = 'none';
            del.style.background = 'transparent';
            del.style.color = varColor('--danger');
            del.style.fontSize = '1.2rem';
            del.style.height = '36px';
            del.onclick = () => { state.shuttles.splice(idx, 1); renderShuttles(); };
            row.appendChild(del);
          }
          cont.appendChild(row);
        });
      }


      // Player events
      $("#add-player").onclick = () => {
        const name = $("#player-name").value.trim();
        if (!name) return;
        const id = uid();
        state.players.push({ id, name });
        state.selected.push(id);
        $("#player-name").value = '';
        renderPlayers();
      };
      $("#toggle-list-view").onclick = () => { state.listExpanded = !state.listExpanded; renderPlayers(); };
      $("#toggle-filter-sel").onclick = () => { state.showSelectedOnly = !state.showSelectedOnly; renderPlayers(); };
      function toggleSelect(id) {
        const i = state.selected.indexOf(id);
        if (i >= 0) state.selected.splice(i, 1);
        else state.selected.push(id);
        renderPlayers();
      }
      $("#select-all").onclick = () => { state.selected = state.players.map(p => p.id); renderPlayers(); };
      $("#deselect-all").onclick = () => { state.selected = []; renderPlayers(); };
      window.editPlayer = (id) => {
        const p = state.players.find(x => x.id === id);
        if (!p) return;
        const n = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠:', p.name);
        if (n && n.trim()) { p.name = n.trim(); renderPlayers(); }
      };
      window.deletePlayer = (id) => {
        const p = state.players.find(x => x.id === id);
        if (!p) return;
        if (confirm(`‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠ "${p.name}" ?`)) {
          state.players = state.players.filter(x => x.id !== id);
          state.selected = state.selected.filter(x => x !== id);
          renderPlayers();
        }
      };

      // Controls: courts, durations, price, shuttles
      $("#court-down").onclick = () => {
        if (state.courts > 1) {
          state.courts--;
          state.durations.pop();
          renderSettings();
          renderPlayers();
        }
      };
      $("#court-up").onclick = () => {
        if (state.selected.length >= (state.courts + 1) * 4) {
          state.courts++;
          state.durations.push(2);
          renderSettings();
          renderPlayers();
        }
      };
      window.changeDur = (idx, d) => {
        let v = state.durations[idx] + d;
        if (v < 1) v = 1;
        state.durations[idx] = v;
        renderSettings();
      };
      $("#court-price").oninput = (e) => { state.courtPrice = parseInt(e.target.value) || 0; };
      $("#add-shuttle").onclick = () => {
        const last = state.shuttles[state.shuttles.length - 1];
        state.shuttles.push({ id: uid(), price: last ? last.price : 75, qty: 1 });
        renderShuttles();
      };
      window.changePriority = (key, delta) => {
        let v = state.priorities[key] + delta;
        if (v < 0) v = 0;
        if (v > 10) v = 10;
        state.priorities[key] = v;
        renderPriorities();
      };
      window.togglePriority = () => {
        state.priorityExpanded = !state.priorityExpanded;
        renderPriorities();
      };
      window.changeSummaryShuttle = (idx, delta) => {
        const s = state.shuttles[idx];
        if (!s) return;
        let v = s.qty + delta;
        if (v < 0) v = 0;
        s.qty = v;
        renderSettings(); // Update settings tab
        drawSummary();    // Re-render summary
      };
      window.toggleSettings = () => {
        state.settingsExpanded = !state.settingsExpanded;
        renderSettings();
      };

      function renderPriorities() {
        const btn = document.getElementById('toggle-priority');
        const cont = document.getElementById('priority-content');
        if (state.priorityExpanded) {
          cont.style.display = 'block';
          btn.textContent = '‚ñº ‡∏ã‡πà‡∏≠‡∏ô';
        } else {
          cont.style.display = 'none';
          btn.textContent = '‚ñ∂ ‡πÅ‡∏™‡∏î‡∏á';
        }
        ['avoidPlay', 'avoidRest', 'equalRounds', 'diversePair'].forEach(k => {
          document.getElementById('prio-' + k).textContent = state.priorities[k];
        });
        saveSaved();
      }

      // Schedule state & functions (from previous version)
      function initScheduleState() {
        const players = state.players.filter(p => state.selected.includes(p.id));
        state.scheduleState = {
          roundIndex: 0,
          playCounts: {},
          pairCounts: {},
          oppCounts: {},
          streaks: {},
          history: {},
          schedule: []
        };
        players.forEach(p => {
          state.scheduleState.playCounts[p.id] = 0;
          state.scheduleState.streaks[p.id] = { type: 'REST', count: 0 };
          state.scheduleState.history[p.id] = [];
        });
      }
      function updateScheduleStatePlayers() {
        if (!state.scheduleState) return;
        const ids = state.players.filter(p => state.selected.includes(p.id)).map(p => p.id);
        const counts = Object.values(state.scheduleState.playCounts);
        const avg = counts.length ? counts.reduce((a, b) => a + b, 0) / counts.length : 0;
        const initVal = Math.floor(avg / 2);
        ids.forEach(id => {
          if (!state.scheduleState.playCounts.hasOwnProperty(id)) {
            state.scheduleState.playCounts[id] = initVal;
            state.scheduleState.history[id] = [];
            state.scheduleState.streaks[id] = { type: 'REST', count: state.scheduleState.roundIndex };
            for (let i = 0; i < state.scheduleState.roundIndex; i++) state.scheduleState.history[id].push(false);
          }
        });
      }
      function getCandidateScore(id) {
        const pc = state.scheduleState.playCounts[id] || 0;
        const st = state.scheduleState.streaks[id] || { type: 'REST', count: 0 };
        const counts = Object.values(state.scheduleState.playCounts);
        const minPlay = counts.length ? Math.min(...counts) : 0;
        let score = 0;
        score += (minPlay - pc) * 500 * state.priorities.equalRounds;
        if (st.type === 'PLAY' && st.count >= 2) score -= 3000 * state.priorities.avoidPlay;
        if (st.type === 'REST' && st.count >= 2) score += 2000 * state.priorities.avoidRest;
        if (st.type === 'REST' && st.count === 1) score += 200 * state.priorities.avoidRest;
        if (st.type === 'PLAY' && st.count === 1) score -= 200 * state.priorities.avoidPlay;
        score += Math.random() * 500;
        return score;
      }
      function groupPairs(pairs, oppCounts) {
        const n = pairs.length;
        let bestGrouping = [];
        let bestMaxOpp = Infinity;
        function recurse(start, current) {
          if (current.length * 2 === n) {
            let maxOpp = 0;
            current.forEach(match => {
              const [pA, pB] = match[0];
              const [pC, pD] = match[1];
              [[pA, pC], [pA, pD], [pB, pC], [pB, pD]].forEach(([x, y]) => {
                const key = [x, y].sort().join('|');
                const c = (oppCounts[key] || 0) + 1;
                if (c > maxOpp) maxOpp = c;
              });
            });
            if (maxOpp < bestMaxOpp) {
              bestMaxOpp = maxOpp;
              bestGrouping = JSON.parse(JSON.stringify(current));
            }
            return;
          }
          for (let i = start; i < pairs.length; i++) {
            for (let j = i + 1; j < pairs.length; j++) {
              recurse(i + 1, current.concat([[pairs[i], pairs[j]]]));
            }
            break;
          }
        }
        recurse(0, []);
        return { grouping: bestGrouping, maxOpp: bestMaxOpp };
      }
      function getCombinations(arr, k) {
        if (k === 0) return [[]];
        if (arr.length < k) return [];
        const [first, ...rest] = arr;
        const withFirst = getCombinations(rest, k - 1).map(c => [first, ...c]);
        const withoutFirst = getCombinations(rest, k);
        return [...withFirst, ...withoutFirst];
      }

      function generateNextRound() {
        if (!state.scheduleState) initScheduleState();
        updateScheduleStatePlayers();
        const players = state.players.filter(p => state.selected.includes(p.id));
        const P = state.courts * 4;
        if (players.length < P) return null;

        // 1. Candidate Selection with Buffer (to allow mixing)
        // We select P + 2 candidates to explore different group combinations
        const cand = players.map(p => ({ id: p.id, score: getCandidateScore(p.id) })).sort((a, b) => b.score - a.score);
        const buffer = 2; // Increase check range
        const poolSize = Math.min(cand.length, P + buffer);
        const topPool = cand.slice(0, poolSize).map(c => c.id);

        // Generate valid subsets of size P
        const subsets = getCombinations(topPool, P);

        let best = null;
        let bestEval = -Infinity;

        subsets.forEach(ids => {
          // greedy pairing for this subset
          const pool = [...ids];
          const pairs = [];
          const tmpPair = { ...state.scheduleState.pairCounts };
          let ok = true;

          while (pool.length >= 2) {
            const p1 = pool.shift();
            let bestP2 = null, minUse = Infinity;

            // Find best partner for p1 from remaining pool
            pool.forEach(p2 => {
              const k = [p1, p2].sort().join('|');
              const u = tmpPair[k] || 0;

              // Exponential penalty for repeats
              // 0 -> 0
              // 1 (2nd time) -> 50
              // 2 (3rd time) -> 5000 (Avoid strongly)
              // 3+ -> 1000000 (Forbidden)
              let score = u * 10;
              if (u >= 1) score += 50;
              if (u >= 2) score += 5000;
              if (u >= 3) score += 1000000;

              if (score < minUse) { minUse = score; bestP2 = p2; }
            });

            if (!bestP2) { ok = false; break; }
            pool.splice(pool.indexOf(bestP2), 1);
            pairs.push([p1, bestP2]);
            const kk = [p1, bestP2].sort().join('|');
            tmpPair[kk] = (tmpPair[kk] || 0) + 1;
          }

          if (!ok) return;

          // Score the entire round (Fairness + Diversity of full set)
          const { grouping, maxOpp } = groupPairs(pairs, state.scheduleState.oppCounts);
          const tmpPlay = { ...state.scheduleState.playCounts };
          const played = new Set(ids);

          // Update temp play counts for this subset
          Object.keys(tmpPlay).forEach(id => { if (played.has(id)) tmpPlay[id]++; });

          const vals = Object.values(tmpPlay);
          const gap = Math.max(...vals) - Math.min(...vals);

          let sumPairRepeats = 0;
          let maxPairRepeat = 0;
          Object.entries(tmpPair).forEach(([k, v]) => {
            // We care about the *new* value `v`.
            // But tmpPair contains ALL history. We want to know if *this round* added bad repeats.
            // Actually `tmpPair` IS the cumulative state.
            if (v > maxPairRepeat) maxPairRepeat = v;
            if (v > 1) sumPairRepeats += (v - 1); // Only penalize repeats
          });

          // Weights
          const scoreEval = -gap * state.priorities.equalRounds * 2000 // High penalty for gap
            - sumPairRepeats * state.priorities.diversePair * 100 // Penalty for overall staleness
            - maxPairRepeat * state.priorities.diversePair * 500 // Penalty for extreme repeats
            - maxOpp * state.priorities.diversePair * 500;

          if (scoreEval > bestEval) {
            bestEval = scoreEval;
            best = { ids, pairs, grouping, tmpPairs: tmpPair, maxOpp };
          }
        });

        if (!best) return null;

        // commit round
        state.scheduleState.roundIndex++;
        const matches = [];
        best.grouping.forEach((match, idx) => {
          const t1 = match[0], t2 = match[1];
          const names1 = t1.map(id => state.players.find(p => p.id === id).name);
          const names2 = t2.map(id => state.players.find(p => p.id === id).name);
          matches.push({ c: idx + 1, t1: names1, t2: names2, ids: [...t1, ...t2] });

          const k1 = [t1[0], t1[1]].sort().join('|');
          const k2 = [t2[0], t2[1]].sort().join('|');
          state.scheduleState.pairCounts[k1] = (state.scheduleState.pairCounts[k1] || 0) + 1;
          state.scheduleState.pairCounts[k2] = (state.scheduleState.pairCounts[k2] || 0) + 1;

          const [a, b] = t1, [c, d] = t2;
          [[a, c], [a, d], [b, c], [b, d]].forEach(([x, y]) => {
            const key = [x, y].sort().join('|');
            state.scheduleState.oppCounts[key] = (state.scheduleState.oppCounts[key] || 0) + 1;
          });
        });

        const playedIds = new Set(best.ids);
        const rests = players.filter(p => !playedIds.has(p.id)).map(p => {
          let cnt = 0; const hist = state.scheduleState.history[p.id] || [];
          for (let i = hist.length - 1; i >= 0; i--) { if (hist[i] === false) cnt++; else break; }
          return { name: p.name, count: cnt + 1 };
        });

        state.scheduleState.schedule.push({
          no: state.scheduleState.roundIndex,
          matches,
          rests,
          playedIds: Array.from(playedIds)
        });

        players.forEach(p => {
          if (playedIds.has(p.id)) {
            state.scheduleState.playCounts[p.id]++;
            state.scheduleState.history[p.id].push(true);
            const st = state.scheduleState.streaks[p.id];
            if (st.type === 'PLAY') st.count++;
            else state.scheduleState.streaks[p.id] = { type: 'PLAY', count: 1 };
          } else {
            state.scheduleState.history[p.id].push(false);
            const st = state.scheduleState.streaks[p.id];
            if (st.type === 'REST') st.count++;
            else state.scheduleState.streaks[p.id] = { type: 'REST', count: 1 };
          }
        });

        return state.scheduleState.schedule[state.scheduleState.schedule.length - 1];
      }

      function drawSchedule() {
        const tbl = $("#schedule-table");
        tbl.innerHTML = '';
        if (state.schedule.length === 0) {
          $("#no-schedule").style.display = 'block';
          $("#schedule-export").style.display = 'none';
          return;
        }
        $("#no-schedule").style.display = 'none';
        $("#schedule-export").style.display = 'flex';
        const info = document.createElement('div');
        info.style.display = 'flex';
        info.style.justifyContent = 'space-between';
        info.style.marginBottom = '1rem';
        info.innerHTML = `
          <strong style="color: var(--primary); font-size: 1rem;">${state.schedule.length} ‡∏£‡∏≠‡∏ö | ${state.selected.length} ‡∏Ñ‡∏ô | ${state.courts} ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</strong>
          <button id="regen" class="btn-xs" style="background: var(--danger); color: #fff; border:none;">‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;
        tbl.appendChild(info);
        document.getElementById('regen').onclick = () => {
          if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            state.schedule = [];
            state.scheduleState = null;
            $("#schedule-table").innerHTML = '';
            $("#no-schedule").style.display = 'block';
            $("#reset").disabled = true;
            $("#to-summary").style.display = 'none';
            $("#schedule-export").style.display = 'none';
          }
        };
        const table = document.createElement('table');
        let head = '<thead><tr><th>#</th>';
        for (let i = 0; i < state.courts; i++) head += `<th>‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${i + 1}</th>`;
        head += '<th>‡∏û‡∏±‡∏Å</th></tr></thead>';
        table.innerHTML = head;
        const body = document.createElement('tbody');
        let prev = [];
        state.schedule.forEach(r => {
          const tr = document.createElement('tr');
          let html = `<td>${r.no}</td>`;
          for (let i = 0; i < state.courts; i++) {
            const m = r.matches.find(x => x.c === i + 1);
            if (m) {
              const fmt = (n, id) => {
                const con = prev.includes(id);
                return con ? `<span class="highlight-consecutive">${n}</span>` : n;
              };
              const t1n1 = fmt(m.t1[0], m.ids[0]);
              const t1n2 = fmt(m.t1[1], m.ids[1]);
              const t2n1 = fmt(m.t2[0], m.ids[2]);
              const t2n2 = fmt(m.t2[1], m.ids[3]);
              html += `<td><div>[ ${t1n1} + ${t1n2} ]</div><div>[ ${t2n1} + ${t2n2} ]</div></td>`;
            } else {
              if (r.no > state.durations[i] * 4) html += `<td style="background:#f1f5f9;color:#cbd5e1;font-size:0.8rem;">(‡∏õ‡∏¥‡∏î)</td>`;
              else html += `<td style="color:#cbd5e1;">-</td>`;
            }
          }
          const restHtml = r.rests.map(o => {
            if (o.count >= 2) return `<span style="color: var(--danger); font-weight: 600;">${o.name}</span>`;
            return o.name;
          }).join(', ');
          html += `<td style="font-size:0.85rem;color:var(--text-muted);">${restHtml}</td>`;
          tr.innerHTML = html;
          body.appendChild(tr);
          prev = r.playedIds;
        });
        table.appendChild(body);
        tbl.appendChild(table);
        $("#to-summary").style.display = 'inline-block';
      }

      function drawSummary() {
        const cont = $('#summary-content');
        cont.innerHTML = '';
        if (state.schedule.length === 0) {
          cont.innerHTML = "<p style='color: var(--text-muted);'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
          $("#summary-export").style.display = 'none';
          return;
        }
        $("#summary-export").style.display = 'flex';
        const stats = {};
        state.selected.forEach(id => {
          stats[id] = {
            name: state.players.find(p => p.id === id).name,
            rounds: 0,
            partners: {},
            cons: 0,
            maxCons: 0,
            last: -1
          };
        });
        let totalPlays = 0;
        state.schedule.forEach(r => {
          r.matches.forEach(m => {
            const add = (id, pid) => {
              const s = stats[id];
              s.rounds++;
              s.partners[pid] = (s.partners[pid] || 0) + 1;
              if (s.last === r.no - 1) {
                s.cons++;
                if (s.cons > s.maxCons) s.maxCons = s.cons;
              } else s.cons = 0;
              s.last = r.no;
              totalPlays++;
            };
            add(m.ids[0], m.ids[1]); add(m.ids[1], m.ids[0]); add(m.ids[2], m.ids[3]); add(m.ids[3], m.ids[2]);
          });
        });
        const totSh = state.shuttles.reduce((a, s) => a + (s.qty || 0), 0);
        if (totSh > 0) {
          const avg = ((totalPlays / 4) / totSh).toFixed(1);
          const d = document.createElement('div');
          d.style.background = varColor('--primary-light');
          d.style.padding = '.5rem';
          d.style.borderRadius = '.5rem';
          d.style.marginBottom = '1rem';
          d.style.color = varColor('--primary-hover');
          d.style.fontWeight = '600';
          d.style.textAlign = 'center';
          d.textContent = `‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î: ${avg} ‡∏£‡∏≠‡∏ö/‡∏•‡∏π‡∏Å`;
          cont.appendChild(d);
        }
        Object.values(stats).forEach(s => {
          const row = document.createElement('div');
          row.className = 'stat-row';
          let consText = '';
          if (s.maxCons > 0) consText = ` | <span style="color: var(--consecutive);">‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ${s.maxCons + 1} ‡∏£‡∏≠‡∏ö</span>`;
          const parts = Object.entries(s.partners).map(([pid, c]) => `${stats[pid].name} (${c})`).join(', ');
          row.innerHTML = `
            <div class="stat-label">${s.name}: ${s.rounds} ‡∏£‡∏≠‡∏ö${consText}</div>
            <div class="stat-dets">‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö: ${parts || '-'}</div>
          `;
          cont.appendChild(row);
        });
        const costCourt = state.durations.reduce((a, b) => a + (b || 0), 0) * state.courtPrice;
        const costShut = state.shuttles.reduce((a, s) => a + (s.price || 0) * (s.qty || 0), 0);
        const total = costCourt + costShut;
        const per = state.selected.length > 0 ? Math.ceil(total / state.selected.length) : 0;
        const card = document.createElement('div');
        card.className = 'cost-card';
        card.innerHTML = `
          <div style="padding:1rem;border-bottom:3px solid var(--primary);display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:1.25rem;color:var(--primary);font-weight:700;">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
            <div style="font-size:0.9rem;font-weight:600;color:var(--text-muted);">${new Date().toLocaleDateString("th-TH", { day: "numeric", month: "short", year: "numeric" })}</div>
          </div>
          <div style="padding:0.5rem 1rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f1f5f9;padding:0.8rem 0;">
              <div>
                <div style="color:var(--text-main);font-weight:700;">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</div>
                <div style="color:var(--text-muted);font-size:0.85rem;">${state.durations.map((d, i) => `‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ${i + 1}: ${d} ‡∏ä‡∏°.`).join(", ")} = ${costCourt}</div>
              </div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-main);">${costCourt}</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f1f5f9;padding:0.8rem 0;">
              <div>
                <div style="color:var(--text-main);font-weight:700;">‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏î</div>
                <div style="color:var(--text-muted);font-size:0.85rem;display:flex;flex-direction:column;gap:0.4rem;">
                  ${state.shuttles.map((s, idx) => `
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                      <span style="min-width:40px;">${s.price}‡∏ö.</span>
                      <div class="stepper" style="height:28px;">
                        <button onclick="changeSummaryShuttle(${idx}, -1)" style="width:28px;height:28px;font-size:1rem;">-</button>
                        <div class="val" style="min-width:30px;line-height:28px;font-size:0.9rem;">${s.qty}</div>
                        <button onclick="changeSummaryShuttle(${idx}, 1)" style="width:28px;height:28px;font-size:1rem;">+</button>
                      </div>
                    </div>
                  `).join("")}
                  <div style="font-weight:600;margin-top:0.2rem;">‡∏£‡∏ß‡∏° ${costShut} ‡∏ö‡∏≤‡∏ó</div>
                </div>
              </div>
              <div style="font-size:1.1rem;font-weight:600;color:var(--text-main);">${costShut}</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:0.8rem 0;">
              <div style="color:var(--text-main);font-weight:700;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              <div style="font-size:1.2rem;font-weight:700;color:var(--text-main);">${total}</div>
            </div>
          </div>
          <div style="background:var(--primary-light);padding:0.8rem;display:flex;justify-content:space-between;align-items:center;">
            <div style="color:var(--primary-hover);font-size:0.95rem;font-weight:600;">‡∏´‡∏≤‡∏£ ${state.selected.length} ‡∏Ñ‡∏ô</div>
            <div style="color:var(--primary-hover);font-size:1.2rem;font-weight:700;">‡∏Ñ‡∏ô‡∏•‡∏∞ ${per}</div>
          </div>
        `;
        cont.appendChild(card);
      }

      // Export image
      window.exportImage = async function (mode, elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        try {
          const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#fff', useCORS: true });
          const blob = await new Promise(res => canvas.toBlob(res));
          if (mode === 'share') {
            const file = new File([blob], 'badminton-summary.png', { type: 'image/png' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({ files: [file], title: 'Badminton Summary', text: '' });
            } else {
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'badminton-summary.png';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          } else {
            try {
              await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
              alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
            } catch (err) {
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'badminton-summary.png';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          }
        } catch (err) {
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ: ' + err.message);
        }
      };

      // Buttons
      $("#generate").onclick = () => {
        const required = state.courts * 4;
        if (state.selected.length < required) {
          alert(`‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${required} ‡∏Ñ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ${state.courts} ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó`);
          return;
        }
        const next = generateNextRound();
        if (!next) {
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ");
          return;
        }
        state.schedule = state.scheduleState.schedule.slice();
        drawSchedule();
        $("#reset").disabled = false;
      };
      $("#reset").onclick = () => {
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
          state.schedule = [];
          state.scheduleState = null;
          drawSchedule();
          $("#reset").disabled = true;
          $("#to-summary").style.display = 'none';
        }
      };
      $("#to-summary").onclick = () => { activateTab('summary'); drawSummary(); };

      // Load saved players/selection then render
      loadSaved();
      renderSettings();
      renderPlayers();
    })();
  </script>
</body>

</html>